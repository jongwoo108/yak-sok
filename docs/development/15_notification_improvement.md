# í‘¸ì‹œ ì•Œë¦¼ UX ê°œì„ 

> ìµœì¢… ì—…ë°ì´íŠ¸: 2026-02-05

---

## ê°œìš”

ì‚¬ìš©ì ê²½í—˜ ê°œì„ ì„ ìœ„í•´ í‘¸ì‹œ ì•Œë¦¼ ë¡œì§ì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.

**ë³€ê²½ ì „**: ì•½ ë‹¨ìœ„ë¡œ ê°œë³„ ì•Œë¦¼ ë°œì†¡ (ì•½ 3ê°œ = ì•Œë¦¼ 3ê°œ)
**ë³€ê²½ í›„**: ì‹œê°„ëŒ€(time_of_day) ë‹¨ìœ„ë¡œ ê·¸ë£¹ ì•Œë¦¼ ë°œì†¡ (ì•½ 3ê°œ = ì•Œë¦¼ 1ê°œ)

---

## ë³€ê²½ ë‚´ìš©

### 1. ì‹œê°„ëŒ€ë³„ ì•Œë¦¼ ê·¸ë£¹í™”

ê°™ì€ ì‚¬ìš©ì, ê°™ì€ ë‚ ì§œ, ê°™ì€ ì‹œê°„ì— ì˜ˆì •ëœ ë³µì•½ì€ **1ê°œì˜ ì•Œë¦¼**ìœ¼ë¡œ í†µí•©ë©ë‹ˆë‹¤.

#### ì˜ˆì‹œ

| ìƒí™© | ë³€ê²½ ì „ | ë³€ê²½ í›„ |
|------|---------|---------|
| ì•„ì¹¨ 08:00ì— ì•½ 3ê°œ | ì•Œë¦¼ 3ê°œ | ì•Œë¦¼ 1ê°œ |
| ì ì‹¬ 12:00ì— ì•½ 2ê°œ | ì•Œë¦¼ 2ê°œ | ì•Œë¦¼ 1ê°œ |
| ì €ë… 18:00ì— ì•½ 2ê°œ | ì•Œë¦¼ 2ê°œ | ì•Œë¦¼ 1ê°œ |
| **í•˜ë£¨ ì´í•©** | **7ê°œ** | **3ê°œ** |

#### ê·¸ë£¹í™” ê¸°ì¤€

- **ê°™ì€ ì‚¬ìš©ì**: ë™ì¼ ì‚¬ìš©ìì˜ ì•½ë§Œ ê·¸ë£¹í™”
- **ê°™ì€ ë‚ ì§œ**: ê°™ì€ ë‚ ì˜ ë³µì•½ë§Œ
- **ê°™ì€ ì‹œê°„ëŒ€(time_of_day)**: morning, noon, evening, night ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
  - 08:00ê³¼ 08:30 ëª¨ë‘ morningì´ë©´ 1ê°œ ì•Œë¦¼

---

### 2. ì‹œê°„ëŒ€ë³„ ë§ì¶¤ ë©”ì‹œì§€

ì‹œê°„ëŒ€(time_of_day)ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.

#### ë³µì•½ ë¦¬ë§ˆì¸ë”

| ì‹œê°„ëŒ€ | ì½”ë“œ | ì œëª© | ë©”ì‹œì§€ |
|--------|------|------|--------|
| ì•„ì¹¨ | `morning` | ë³µì•½ ì•Œë¦¼ | ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”! ì•„ì¹¨ì•½ ë“œì‹¤ ì‹œê°„ì´ì—ìš”. |
| ì ì‹¬ | `noon` | ë³µì•½ ì•Œë¦¼ | ì ì‹¬ì•½ ë“œì‹¤ ì‹œê°„ì´ì—ìš”. |
| ì €ë… | `evening` | ë³µì•½ ì•Œë¦¼ | ì €ë…ì•½ ë“œì‹¤ ì‹œê°„ì´ì—ìš”. |
| ì·¨ì¹¨ ì „ | `night` | ë³µì•½ ì•Œë¦¼ | ì£¼ë¬´ì‹œê¸° ì „ ì•½ ë“œì…¨ë‚˜ìš”? |
| ì‚¬ìš©ì ì§€ì • | `custom` | ë³µì•½ ì•Œë¦¼ | ì•½ ë“œì‹¤ ì‹œê°„ì´ì—ìš”. |

#### ë¯¸ë³µì•½ ì•Œë¦¼ (ë³µì•½ ì‹œê°„ 30ë¶„ ê²½ê³¼ í›„)

| ì‹œê°„ëŒ€ | ì½”ë“œ | ì œëª© | ë©”ì‹œì§€ |
|--------|------|------|--------|
| ì•„ì¹¨ | `morning` | ë¯¸ë³µì•½ ì•Œë¦¼ | ì•„ì¹¨ì•½ ë³µìš© ì‹œê°„ì´ 30ë¶„ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤. |
| ì ì‹¬ | `noon` | ë¯¸ë³µì•½ ì•Œë¦¼ | ì ì‹¬ì•½ ë³µìš© ì‹œê°„ì´ 30ë¶„ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤. |
| ì €ë… | `evening` | ë¯¸ë³µì•½ ì•Œë¦¼ | ì €ë…ì•½ ë³µìš© ì‹œê°„ì´ 30ë¶„ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤. |
| ì·¨ì¹¨ ì „ | `night` | ë¯¸ë³µì•½ ì•Œë¦¼ | ì·¨ì¹¨ì „ ì•½ ë³µìš© ì‹œê°„ì´ 30ë¶„ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤. |
| ì‚¬ìš©ì ì§€ì • | `custom` | ë¯¸ë³µì•½ ì•Œë¦¼ | ì•½ ë³µìš© ì‹œê°„ì´ 30ë¶„ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤. |

---

### 3. ì´ëª¨ì§€ ì œê±°

ëª¨ë“  í‘¸ì‹œ ì•Œë¦¼ì—ì„œ ì´ëª¨ì§€ë¥¼ ì œê±°í•˜ì—¬ ê¹”ë”í•œ ì•Œë¦¼ì„ ì œê³µí•©ë‹ˆë‹¤.

| í•­ëª© | ë³€ê²½ ì „ | ë³€ê²½ í›„ |
|------|---------|---------|
| ë³µì•½ ì•Œë¦¼ ì œëª© | ğŸ’Š ë³µì•½ ì‹œê°„ì´ì—ìš”! | ë³µì•½ ì•Œë¦¼ |
| í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì œëª© | ğŸ”” í…ŒìŠ¤íŠ¸ ì•Œë¦¼ | í…ŒìŠ¤íŠ¸ ì•Œë¦¼ |
| ë³´í˜¸ì ì•Œë¦¼ ì œëª© | âš ï¸ ë³µì•½ ë¯¸í™•ì¸ ì•Œë¦¼ | ë³µì•½ ë¯¸í™•ì¸ ì•Œë¦¼ |

---

## ê¸°ìˆ  êµ¬í˜„

### ìˆ˜ì •ëœ íŒŒì¼

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|-----------|
| `backend/apps/alerts/tasks.py` | ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€ ì •ì˜, ì¤‘ë³µ ë°œì†¡ ë°©ì§€, ë§¤ì¼ ìŠ¤ì¼€ì¤„ëŸ¬ |
| `backend/apps/medications/serializers.py` | ì•½ ë“±ë¡ ì‹œ ì•Œë¦¼ ì˜ˆì•½ ì œê±° (ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ ì¼ê´„ ì²˜ë¦¬) |
| `backend/apps/alerts/fcm_service.py` | ì´ëª¨ì§€ ì œê±° |
| `backend/apps/alerts/views.py` | patient ì—­í•  ì•Œë¦¼ ì „ì†¡ ì§€ì› |
| `backend/core/settings.py` | Redis ìºì‹œ ë°±ì—”ë“œ ì„¤ì •, Celery Beat ìŠ¤ì¼€ì¤„ |

### ì•Œë¦¼ ìŠ¤ì¼€ì¤„ë§ êµ¬ì¡°

```
[ë§¤ì¼ 00:05] schedule_daily_reminders (Celery Beat)
    â†“
[ì‚¬ìš©ìë³„, ì‹œê°„ëŒ€ë³„ ì²« ë²ˆì§¸ ë¡œê·¸ë§Œ] schedule_medication_alert
    â†“
[ì •ì‹œ] send_scheduled_reminder â†’ ë³µì•½ ë¦¬ë§ˆì¸ë”
[ì •ì‹œ+30ë¶„] trigger_safety_alert â†’ ë¯¸ë³µì•½ ì•Œë¦¼
```

### í•µì‹¬ ì½”ë“œ

#### ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€ ì •ì˜ (`tasks.py`)

```python
TIME_SLOT_MESSAGES = {
    'morning': {
        'title': 'ë³µì•½ ì•Œë¦¼',
        'body': 'ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”! ì•„ì¹¨ì•½ ë“œì‹¤ ì‹œê°„ì´ì—ìš”.',
        'missed_title': 'ë¯¸ë³µì•½ ì•Œë¦¼',
        'missed_body': 'ì•„ì¹¨ì•½ ë³µìš© ì‹œê°„ì´ 30ë¶„ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤.'
    },
    # noon, evening, night, custom...
}
```

#### ì¤‘ë³µ ë°œì†¡ ë°©ì§€ - cache.add() ì‚¬ìš© (`tasks.py`)

```python
# ìºì‹œ í‚¤: user_id + ë‚ ì§œ + ì‹œê°„ëŒ€(time_of_day)
cache_key = f"reminder_sent:{user.id}:{scheduled_time.strftime('%Y-%m-%d')}:{time_of_day}"

# cache.add()ëŠ” í‚¤ê°€ ì—†ì„ ë•Œë§Œ ì„¤ì • (atomic operation, race condition ë°©ì§€)
if not cache.add(cache_key, True, 3600):
    return {'status': 'skipped', 'reason': 'already_sent_for_time_slot'}
```

#### ë§¤ì¼ ì•Œë¦¼ ìŠ¤ì¼€ì¤„ëŸ¬ (`tasks.py`)

```python
@shared_task
def schedule_daily_reminders():
    """ë§¤ì¼ 00:05ì— ì‹¤í–‰ - ì˜¤ëŠ˜ì˜ pending ë¡œê·¸ì— ëŒ€í•´ ì•Œë¦¼ ì˜ˆì•½"""
    logs = MedicationLog.objects.filter(
        scheduled_datetime__date=today,
        status='pending'
    )
    
    scheduled_alerts = set()  # (user_id, time_of_day)
    for log in logs:
        key = (user_id, time_of_day)
        if key not in scheduled_alerts:
            schedule_medication_alert.delay(log.id)
            scheduled_alerts.add(key)
```

#### Django Redis ìºì‹œ ì„¤ì • (`settings.py`)

```python
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': os.environ.get('CELERY_BROKER_URL', 'redis://localhost:6379/0'),
    }
}
```

---

## ë°°í¬ ë°©ë²•

ë°±ì—”ë“œ ì½”ë“œë§Œ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ì„œë²„ ì¬ì‹œì‘ë§Œ í•„ìš”í•©ë‹ˆë‹¤.

```bash
# ì„œë²„ ì ‘ì†
ssh -i ~/.ssh/LightsailDefaultKey-ap-northeast-2.pem ubuntu@3.39.142.149

# ì½”ë“œ ì—…ë°ì´íŠ¸
cd /app/yak-sok
git pull origin main

# ì„œë²„ ì¬ë¹Œë“œ ë° ì¬ì‹œì‘
docker-compose -f docker-compose.prod.yml up -d --build backend celery_worker celery_beat

# ìƒíƒœ í™•ì¸
docker-compose -f docker-compose.prod.yml ps
```

**ì•± ì¬ë¹Œë“œ í•„ìš” ì—†ìŒ**: ì•Œë¦¼ ë©”ì‹œì§€ëŠ” ì„œë²„ì—ì„œ ë°œì†¡í•˜ë¯€ë¡œ ê¸°ì¡´ ì•± ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥

---

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### ìˆ˜ë™ í…ŒìŠ¤íŠ¸

```bash
docker-compose -f docker-compose.prod.yml exec backend python manage.py shell
```

```python
from apps.alerts.tasks import schedule_daily_reminders
result = schedule_daily_reminders()
print(result)
# {'status': 'completed', 'date': '2026-02-05', 'scheduled': 16, 'skipped': 57, 'total_logs': 73}
```

### ì˜ˆìƒ ê²°ê³¼

- ì•„ì¹¨ 08:00ì— ì•½ 3ê°œ ë“±ë¡ â†’ 08:00ì— "ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”! ì•„ì¹¨ì•½ ë“œì‹¤ ì‹œê°„ì´ì—ìš”." **1ê°œ**
- ì•„ì¹¨ ì•½ ë¯¸ë³µìš© ì‹œ â†’ 08:30ì— "ì•„ì¹¨ì•½ ë³µìš© ì‹œê°„ì´ 30ë¶„ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤." **1ê°œ**

---

## ì£¼ì˜ì‚¬í•­ (íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

### FCM í† í° ì¤‘ë³µ ë¬¸ì œ

ì—¬ëŸ¬ ê³„ì •ì´ ê°™ì€ FCM í† í°ì„ ì‚¬ìš©í•˜ë©´ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì•Œë¦¼ì´ ì „ë‹¬ë©ë‹ˆë‹¤.

**í™•ì¸ ë°©ë²•:**
```python
from apps.users.models import User
patient_token = User.objects.get(id=8).fcm_token
same_token_users = User.objects.filter(fcm_token=patient_token)
for u in same_token_users:
    print(f"user={u.id}, email={u.email}")
```

**í•´ê²° ë°©ë²•:**
- í…ŒìŠ¤íŠ¸ ê³„ì •ì˜ FCM í† í°ì„ ë¹ˆ ë¬¸ìì—´ë¡œ ë³€ê²½
- ë˜ëŠ” ê° ê¸°ê¸°ì—ì„œ í•´ë‹¹ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ í† í° ê°±ì‹ 

### Celery íì— ë‚¨ì•„ìˆëŠ” íƒœìŠ¤í¬

ì´ì „ì— ì˜ˆì•½ëœ íƒœìŠ¤í¬ê°€ ë‚¨ì•„ìˆìœ¼ë©´ ì¤‘ë³µ ì•Œë¦¼ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# Celery í ë¹„ìš°ê¸°
docker-compose -f docker-compose.prod.yml exec celery_worker celery -A core purge -f

# Redis ìºì‹œ ì´ˆê¸°í™”
docker-compose -f docker-compose.prod.yml exec redis redis-cli FLUSHALL
```

---

## ê´€ë ¨ ë¬¸ì„œ

- [ë³µì•½ ê´€ë¦¬ API](./04_api_specification.md)
- [Safety Line êµ¬í˜„](./02_backend_development.md#safety-line)
- [FCM í‘¸ì‹œ ì•Œë¦¼](./02_backend_development.md#í‘¸ì‹œ-ì•Œë¦¼)

---

**ì‘ì„±ì¼**: 2026-02-02
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2026-02-05
**ìƒíƒœ**: ë°°í¬ ì™„ë£Œ
