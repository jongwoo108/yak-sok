# v1.0.2 개발 일지 (2026-02-02)

## 개요

이번 업데이트에서는 버그 수정, UX 개선, 그리고 Google 소셜 로그인 기능을 추가했습니다.

---

## 1. 복약자(PATIENT) 모니터링 버그 수정

### 문제
보호자가 **복약자(PATIENT)** 역할의 사용자를 연결했을 때, 시니어 관리 탭에서 복약 현황이 조회되지 않는 버그.

### 원인
`SeniorMonitoringMixin`에서 `SENIOR` 역할만 체크하고 `PATIENT` 역할은 제외되어 있었음.

### 해결
**파일**: `backend/apps/medications/views.py`

```python
# 변경 전
if guardian.senior_role != 'SENIOR':
    return Response({'error': '...'}, status=403)

# 변경 후
if guardian.senior_role not in ['SENIOR', 'PATIENT']:
    return Response({'error': '...'}, status=403)
```

---

## 2. 회원가입 이메일 중복 체크 UX 개선

### 문제
사용자가 회원가입 전체 과정(Step 1~4)을 완료한 후에야 이메일 중복 오류를 확인할 수 있었음.

### 해결
Step 1 → Step 2로 넘어갈 때 **사전 이메일 중복 체크**를 수행하도록 변경.

### 변경 파일

#### 백엔드
- `backend/apps/users/views.py`: `CheckEmailView` 추가
- `backend/apps/users/urls.py`: `/api/users/check-email/` 엔드포인트 추가

```python
class CheckEmailView(APIView):
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        email = request.data.get('email', '').strip().lower()
        exists = User.objects.filter(email=email).exists()
        
        if exists:
            return Response({'available': False, 'error': '이미 가입된 이메일입니다.'})
        return Response({'available': True, 'message': '사용 가능한 이메일입니다.'})
```

#### 프론트엔드
- `mobile/services/api.ts`: `api.auth.checkEmail()` 함수 추가
- `mobile/app/(auth)/register.tsx`: Step 1에서 이메일 중복 체크 로직 추가

---

## 3. 시니어 관리 탭 UI 그룹화

### 개선 내용
복약 현황을 **시간대 + 그룹별 카드** 형태로 그룹화하여 보호자가 한눈에 파악할 수 있도록 개선.

### 변경 전
- 모든 약이 플랫 리스트로 나열
- 작은 dot으로 상태 표시

### 변경 후
- 시간대(아침/점심/저녁/밤) + 그룹별 카드로 구분
- 체크박스 + 상태 라벨로 명확히 표시
- 그룹별 진행률 표시 (예: "2/3 복용")

### 변경 파일
- `mobile/app/(tabs)/seniors.tsx`: UI 컴포넌트 및 스타일 추가

---

## 4. Google 소셜 로그인 구현

### 구현 방식
`expo-auth-session`을 사용한 **Access Token 방식** Google OAuth 2.0 로그인.

### 인증 흐름
```
1. 사용자가 "Google로 로그인" 버튼 클릭
2. Google OAuth 팝업 표시
3. 사용자 인증 후 Access Token 반환
4. Access Token으로 Google API에서 사용자 정보 조회
5. 백엔드에 Access Token + User Info 전송
6. 백엔드에서 토큰 검증 후 사용자 생성/로그인
7. JWT 토큰 발급
```

### 변경 파일

#### 프론트엔드
- `mobile/app/(auth)/login.tsx`
  - `GoogleLoginButton` 컴포넌트 (Access Token 방식)
  - `handleGoogleLoginSuccess` 핸들러
  
- `mobile/services/api.ts`
  - `googleLogin(accessToken, userInfo)` 함수

- `mobile/.env`
  ```
  GOOGLE_IOS_CLIENT_ID=xxx.apps.googleusercontent.com
  GOOGLE_WEB_CLIENT_ID=xxx.apps.googleusercontent.com
  ```

#### 백엔드
- `backend/apps/users/views.py`: `GoogleLoginView` (Access Token 검증 방식)

```python
class GoogleLoginView(APIView):
    def post(self, request):
        access_token = request.data.get('access_token')
        user_info = request.data.get('user_info')
        
        # Google API로 토큰 검증
        verify_response = requests.get(
            'https://www.googleapis.com/oauth2/v3/tokeninfo',
            params={'access_token': access_token}
        )
        
        # 사용자 생성/로그인 처리
        user, created = User.objects.get_or_create(email=email, ...)
        tokens = get_tokens_for_user(user)
        
        return Response({'user': ..., 'tokens': tokens})
```

### Google Cloud Console 설정
1. **OAuth 2.0 클라이언트 ID** 생성
   - iOS: 번들 ID `com.jongwoo.yaksok`
   - Web: 승인된 리디렉션 URI (Expo가 자동 생성)

2. **OAuth 동의 화면** 설정
   - 앱 이름: `약속`
   - 스코프: `openid`, `profile`, `email`

3. **EAS Secrets** 등록
   ```bash
   eas secret:create --name GOOGLE_IOS_CLIENT_ID --value "xxx"
   eas secret:create --name GOOGLE_WEB_CLIENT_ID --value "xxx"
   ```

---

## 배포 정보

- **앱 버전**: 1.0.2
- **빌드 번호**: 14
- **배포 일자**: 2026-02-02

### 배포 체크리스트
- [x] 백엔드 코드 서버 배포 (`docker-compose -f docker-compose.prod.yml up -d --build`)
- [x] iOS 앱 빌드 (`eas build --platform ios`)
- [x] TestFlight 업로드 및 테스트
- [x] 기능 테스트 완료
  - [x] 복약자 모니터링
  - [x] 이메일 중복 체크
  - [x] 시니어 관리 UI
  - [x] Google 로그인

---

## 다음 작업 예정

- [ ] 카카오 소셜 로그인 구현
- [ ] 앱 스토어 정식 출시
